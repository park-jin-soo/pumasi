<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 품앗이 센터 V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 800px; }
        .header { padding: 2rem 0; text-align: center; }
        .header h1 { font-weight: 700; }
        .auth-container { max-width: 400px; margin: auto; }
        .hidden { display: none; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day, .calendar-day-name { text-align: center; padding: 0.5rem; }
        .calendar-day-name { font-weight: bold; color: #6c757d; }
        .calendar-day { background-color: #fff; border: 1px solid #e9ecef; border-radius: 0.25rem; }
        .calendar-day.other-month { color: #ced4da; }
        .calendar-day.today { background-color: #198754; color: white; font-weight: bold; }
        .calendar-day.active-day { cursor: pointer; border: 2px solid #198754; }
        .calendar-day.active-day:hover { background-color: #e9f5ee; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        #completionBtn:disabled { cursor: not-allowed; }
        .penalty-1 { color: #ffc107; }
        .penalty-2 { color: #fd7e14; }
        .penalty-3 { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1>네이버 품앗이 센터 V2</h1>
        </header>

        <div id="authView">
            <div class="card auth-container">
                <div class="card-body p-4">
                    <ul class="nav nav-tabs nav-fill mb-4" id="authTab" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">로그인</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">회원가입</button>
                      </li>
                    </ul>

                    <div class="tab-content">
                      <div class="tab-pane active" id="login" role="tabpanel">
                        <h5 class="card-title text-center mb-3">로그인</h5>
                        <div class="mb-3">
                            <label for="loginIdInput" class="form-label">블로그 아이디</label>
                            <input type="text" class="form-control" id="loginIdInput">
                        </div>
                        <div class="d-grid">
                            <button id="loginButton" class="btn btn-primary">로그인</button>
                        </div>
                      </div>
                      <div class="tab-pane" id="register" role="tabpanel">
                        <h5 class="card-title text-center mb-3">회원가입</h5>
                        <div class="mb-3">
                            <label for="registerIdInput" class="form-label">블로그 아이디</label>
                            <input type="text" class="form-control" id="registerIdInput">
                        </div>
                        <div class="mb-3">
                            <label for="registerLinkInput" class="form-label">블로그 링크 (모바일)</label>
                            <input type="url" class="form-control" id="registerLinkInput" placeholder="https://m.blog.naver.com/아이디">
                        </div>
                        <div class="d-grid">
                            <button id="registerButton" class="btn btn-success">가입하기</button>
                        </div>
                      </div>
                    </div>
                    <div id="authAlert" class="alert mt-3 hidden" role="alert"></div>
                </div>
            </div>
        </div>

        <main id="mainView" class="hidden">
            <div class="card mb-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <p class="mb-0"><strong><span id="welcomeMessage"></span></strong>님, 환영합니다.</p>
                    <div>
                        <button id="adminLoginBtn" class="btn btn-sm btn-outline-danger me-2">관리자</button>
                        <button id="logoutButton" class="btn btn-sm btn-outline-secondary">로그아웃</button>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs nav-fill mb-3" id="mainAppTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="submission-tab" data-bs-toggle="tab" data-bs-target="#submission" type="button" role="tab">품앗이 링크 저장</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">품앗이 완료 및 보고서</button>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane active" id="submission" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center p-2">
                            <button id="prevMonth" class="btn btn-outline-secondary">&lt;</button>
                            <h4 id="currentMonthYear" class="mb-0"></h4>
                            <button id="nextMonth" class="btn btn-outline-secondary">&gt;</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-day-name">일</div><div class="calendar-day-name">월</div><div class="calendar-day-name">화</div><div class="calendar-day-name">수</div><div class="calendar-day-name">목</div><div class="calendar-day-name">금</div><div class="calendar-day-name">토</div>
                        </div>
                        <div class="calendar-grid" id="calendarBody"></div>
                    </div>
                </div>
              </div>

              <div class="tab-pane" id="report" role="tabpanel">
                 <div class="card mb-4">
                    <div class="card-header"><h4>금일 품앗이 완료 보고</h4></div>
                    <div class="card-body text-center">
                        <p id="completionTimer" class="text-muted">완료 보고 활성화까지 남은 시간: 00:00:00</p>
                        <button id="completionBtn" class="btn btn-success btn-lg" disabled>품앗이 완료 확인</button>
                    </div>
                 </div>

                 <div class="card">
                    <div class="card-header"><h4>어제 품앗이 완료 보고서</h4></div>
                    <div id="reportContent" class="card-body">
                        <p class="text-center">보고서를 불러오는 중입니다...</p>
                    </div>
                 </div>
              </div>
            </div>
        </main>
        
        <div id="adminView" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">관리자 모드</h2>
                <button id="exitAdminBtn" class="btn btn-secondary">메인으로 돌아가기</button>
            </div>
            <div id="adminAlert" class="alert mt-3 hidden" role="alert"></div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>아이디</th>
                            <th>블로그 링크</th>
                            <th>가입일</th>
                            <th>상태</th>
                            <th>패널티</th>
                            <th>잠금 종료일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserTable"></tbody>
                </table>
            </div>
        </div>

    </div> <div class="modal fade" id="linkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        네이버 <b>모바일 버전(m.blog.naver.com)</b> 링크만 가능합니다.<br>
                        (PC버전, <b>클립(Clip)</b>, 단축URL, 타 블로그 불가)
                    </div>
                    <p><strong>아이디:</strong> <span id="modalUserId"></span></p>
                    <div class="mb-3"><label class="form-label">링크 1 (필수)</label><input type="url" class="form-control" id="linkInput1" placeholder="https://m.blog.naver.com/..."></div>
                    <div class="mb-3"><label class="form-label">링크 2</label><input type="url" class="form-control" id="linkInput2" placeholder="https://m.blog.naver.com/..."></div>
                    <div class="mb-3"><label class="form-label">링크 3</label><input type="url" class="form-control" id="linkInput3" placeholder="https://m.blog.naver.com/..."></div>
                    <div id="linkModalAlert" class="alert mt-3 hidden" role="alert"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button><button type="button" class="btn btn-primary" id="saveLinksButton">저장하기</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="completionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">품앗이 완료 확인</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p>금일 모든 품앗이 완료 되었음을 보고 합니다.</p>
                    <p>좋아요, 댓글, 체류 완료 되었습니다.</p>
                    <p class="text-muted small">아래 확인버튼 누르시면 금일 품앗이는 모두 완료됩니다.</p>
                    <div id="completionModalAlert" class="alert mt-3 hidden" role="alert"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="confirmCompletionButton">확인</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="adminPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">관리자 로그인</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="adminPasswordInput" class="form-label">비밀번호</label><input type="password" class="form-control" id="adminPasswordInput"></div>
                    <div id="adminPasswordAlert" class="alert alert-danger hidden" role="alert"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="adminSubmitPasswordButton">진입</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="adminEditTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="adminEditUserId">
                    <div class="mb-3"><label class="form-label">상태 (ACTIVE, BLOCKED)</label><input type="text" class="form-control" id="adminEditStatus"></div>
                    <div class="mb-3"><label class="form-label">패널티 횟수</label><input type="number" class="form-control" id="adminEditPenaltyCount" min="0"></div>
                    <div class="mb-3"><label class="form-label">잠금 종료일 (yyyy-mm-dd 또는 비우기)</label><input type="text" class="form-control" id="adminEditLockoutDate"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="adminSaveChangesButton">변경사항 저장</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ######################################################################
    // ##### SCRIPT_URL: 여기에 새로 배포한 웹 앱 URL을 붙여넣으세요 #####
    // ######################################################################
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzsjtEHfQn6THdxmB3u0Z2rNokZYaSbX8T9z8YuGOcmpW-Cy-ELpCZVg5dwKFr5OW85/exec';
    const ADMIN_PASSWORD_FRONT = "7702";

    document.addEventListener('DOMContentLoaded', () => {
        // --- View Elements ---
        const authView = document.getElementById('authView');
        const mainView = document.getElementById('mainView');
        const adminView = document.getElementById('adminView');
        const allViews = [authView, mainView, adminView];

        // --- Auth Elements ---
        const loginIdInput = document.getElementById('loginIdInput');
        const loginButton = document.getElementById('loginButton');
        const registerIdInput = document.getElementById('registerIdInput');
        const registerLinkInput = document.getElementById('registerLinkInput');
        const registerButton = document.getElementById('registerButton');
        const authAlert = document.getElementById('authAlert');

        // --- Main View Elements ---
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutButton = document.getElementById('logoutButton');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const calendarBody = document.getElementById('calendarBody');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const completionBtn = document.getElementById('completionBtn');
        const completionTimer = document.getElementById('completionTimer');
        const reportContent = document.getElementById('reportContent');

        // --- Modals ---
        const linkModal = new bootstrap.Modal(document.getElementById('linkModal'));
        const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
        const adminPasswordModal = new bootstrap.Modal(document.getElementById('adminPasswordModal'));
        const adminEditModal = new bootstrap.Modal(document.getElementById('adminEditModal'));

        // --- Link Modal Elements ---
        const modalTitle = document.getElementById('modalTitle');
        const modalUserId = document.getElementById('modalUserId');
        const linkInputs = [document.getElementById('linkInput1'), document.getElementById('linkInput2'), document.getElementById('linkInput3')];
        const linkModalAlert = document.getElementById('linkModalAlert');
        const saveLinksButton = document.getElementById('saveLinksButton');

        // --- Completion Modal Elements ---
        const confirmCompletionButton = document.getElementById('confirmCompletionButton');
        const completionModalAlert = document.getElementById('completionModalAlert');

        // --- Admin Elements ---
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminSubmitPasswordButton = document.getElementById('adminSubmitPasswordButton');
        const adminPasswordAlert = document.getElementById('adminPasswordAlert');
        const adminUserTable = document.getElementById('adminUserTable');
        const exitAdminBtn = document.getElementById('exitAdminBtn');
        const adminAlert = document.getElementById('adminAlert');
        
        // --- Admin Edit Modal Elements ---
        const adminEditTitle = document.getElementById('adminEditTitle');
        const adminEditUserId = document.getElementById('adminEditUserId');
        const adminEditStatus = document.getElementById('adminEditStatus');
        const adminEditPenaltyCount = document.getElementById('adminEditPenaltyCount');
        const adminEditLockoutDate = document.getElementById('adminEditLockoutDate');
        const adminSaveChangesButton = document.getElementById('adminSaveChangesButton');


        // --- App State ---
        let currentCalendarDate = new Date();
        let loggedInUserId = null;
        let selectedDateStr = '';
        let completionInterval;

        // --- UTILITY FUNCTIONS ---
        
        function showView(viewToShow) {
            allViews.forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        }

        function showAlert(alertElement, message, type = 'danger') {
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
        }
        
        function hideAlert(alertElement) {
            alertElement.classList.add('hidden');
        }

        async function apiCall(action, params = {}) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, ...params })
                });
                if (!response.ok) throw new Error("네트워크 응답이 올바르지 않습니다.");
                
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                
                return result.data;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }
        
        // --- INITIALIZATION ---

        function init() {
            loggedInUserId = localStorage.getItem('pumasi_user_id');
            if (loggedInUserId) {
                showView(mainView);
                initializeApp();
            } else {
                showView(authView);
            }
        }
        
        function initializeApp() {
            welcomeMessage.textContent = loggedInUserId;
            renderCalendar(currentCalendarDate);
            startCompletionTimer();
            loadReportData();
        }

        // --- AUTHENTICATION ---
        
        loginButton.addEventListener('click', async () => {
            const userId = loginIdInput.value.trim();
            if (!userId) { showAlert(authAlert, "아이디를 입력하세요."); return; }
            
            try {
                const data = await apiCall('loginUser', { userId });
                localStorage.setItem('pumasi_user_id', data.userId);
                loggedInUserId = data.userId;
                showView(mainView);
                initializeApp();
            } catch (error) {
                showAlert(authAlert, error.message);
            }
        });

        registerButton.addEventListener('click', async () => {
            const userId = registerIdInput.value.trim();
            const blogLink = registerLinkInput.value.trim();
            if (!userId || !blogLink) { showAlert(authAlert, "아이디와 블로그 링크를 모두 입력하세요."); return; }
            
            try {
                const data = await apiCall('registerUser', { userId, blogLink });
                showAlert(authAlert, data.message, 'success');
                // Switch to login tab
                document.getElementById('login-tab').click();
            } catch (error) {
                showAlert(authAlert, error.message);
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('pumasi_user_id');
            loggedInUserId = null;
            clearInterval(completionInterval);
            showView(authView);
        });

        // --- CALENDAR & LINK SUBMISSION ---

        function renderCalendar(date) {
            calendarBody.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            currentMonthYear.textContent = `${year}년 ${month + 1}월`;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarBody.innerHTML += `<div class="calendar-day other-month"></div>`; }
            
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            for (let i = 1; i <= lastDate; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.textContent = i;
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (currentDateStr === todayStr) {
                    dayDiv.classList.add('today', 'active-day');
                    dayDiv.dataset.date = currentDateStr;
                }
                calendarBody.appendChild(dayDiv);
            }
        }
        
        prevMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate); });
        nextMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate); });
        
        calendarBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('active-day')) {
                selectedDateStr = e.target.dataset.date;
                modalTitle.textContent = `${selectedDateStr} 링크 등록`;
                modalUserId.textContent = loggedInUserId;
                linkInputs.forEach(input => input.value = '');
                hideAlert(linkModalAlert);
                linkModal.show();
            }
        });

        function validateLink(url) {
            if (!url.startsWith("https://m.blog.naver.com")) return false;
            if (url.toLowerCase().includes("clip")) return false;
            return true;
        }

        saveLinksButton.addEventListener('click', async () => {
            const links = linkInputs.map(input => input.value.trim()).filter(link => link);
            if (links.length === 0) { showAlert(linkModalAlert, '링크를 하나 이상 입력해주세요.'); return; }
            
            for (const link of links) {
                if (!validateLink(link)) {
                    showAlert(linkModalAlert, '네이버 모바일 버전 링크를 입력해주세요. (Clip 포함 불가)');
                    return;
                }
            }

            saveLinksButton.disabled = true;
            try {
                const data = await apiCall('saveLinks', { userId: loggedInUserId, date: selectedDateStr, links });
                showAlert(linkModalAlert, data.message, 'success');
                setTimeout(() => linkModal.hide(), 1500);
            } catch (error) {
                showAlert(linkModalAlert, error.message);
            } finally {
                saveLinksButton.disabled = false;
            }
        });

        // --- COMPLETION & REPORT ---

        function startCompletionTimer() {
            clearInterval(completionInterval);
            completionInterval = setInterval(updateCompletionButtonStatus, 1000);
            updateCompletionButtonStatus();
        }

        function updateCompletionButtonStatus() {
            const now = new Date();
            // KST is UTC+9
            const kstOffset = 9 * 60 * 60 * 1000;
            const kstTime = new Date(now.getTime() + kstOffset);
            
            const kstHours = kstTime.getUTCHours();
            const kstMinutes = kstTime.getUTCMinutes();
            
            const startTime = 18.5; // 18:30
            const endTime = 23.5;   // 23:30
            const currentTime = kstHours + kstMinutes / 60;

            if (currentTime >= startTime && currentTime <= endTime) {
                completionBtn.disabled = false;
                completionTimer.textContent = "지금 완료 보고가 가능합니다.";
            } else {
                completionBtn.disabled = true;
                let nextStart = new Date(kstTime);
                nextStart.setUTCHours(18, 30, 0, 0);
                if (kstTime > nextStart) { nextStart.setUTCDate(nextStart.getUTCDate() + 1); }
                
                const diff = nextStart - kstTime;
                const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
                const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                completionTimer.textContent = `완료 보고 활성화까지 남은 시간: ${h}:${m}:${s}`;
            }
        }
        
        completionBtn.addEventListener('click', () => {
            hideAlert(completionModalAlert);
            completionModal.show();
        });

        confirmCompletionButton.addEventListener('click', async () => {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            confirmCompletionButton.disabled = true;
            try {
                const data = await apiCall('recordCompletion', { userId: loggedInUserId, date: todayStr });
                showAlert(completionModalAlert, data.message, 'success');
                setTimeout(() => completionModal.hide(), 1500);
            } catch (error) {
                showAlert(completionModalAlert, error.message);
            } finally {
                confirmCompletionButton.disabled = false;
            }
        });

        async function loadReportData() {
            try {
                const data = await apiCall('getReportData');
                let html = `
                    <p class="mb-2"><strong>보고서 날짜: ${data.date}</strong></p>
                    <p class="mb-3"><strong>완료 인원: ${data.completedCount}명</strong></p>
                    <h5>미완료 회원 목록</h5>
                `;
                if (data.incompleteUsers.length === 0) {
                    html += `<p class="text-muted">미완료 회원이 없습니다.</p>`;
                } else {
                    html += `<ul class="list-group">`;
                    data.incompleteUsers.forEach(user => {
                        const penaltyClass = `penalty-${Math.min(user.penaltyCount, 3)}`;
                        html += `<li class="list-group-item">
                            ${user.userId} <span class="badge bg-warning text-dark ${penaltyClass}">패널티 ${user.penaltyCount}회</span>
                        </li>`;
                    });
                    html += `</ul>`;
                }
                reportContent.innerHTML = html;
            } catch (error) {
                reportContent.innerHTML = `<p class="text-danger">보고서 로딩 실패: ${error.message}</p>`;
            }
        }
        
        // --- ADMIN ---
        
        adminLoginBtn.addEventListener('click', () => {
            adminPasswordInput.value = '';
            hideAlert(adminPasswordAlert);
            adminPasswordModal.show();
        });

        adminSubmitPasswordButton.addEventListener('click', () => {
            const pass = adminPasswordInput.value;
            if (pass === ADMIN_PASSWORD_FRONT) {
                adminPasswordModal.hide();
                showView(adminView);
                adminFetchUsers();
            } else {
                showAlert(adminPasswordAlert, "비밀번호가 틀렸습니다.");
            }
        });
        
        exitAdminBtn.addEventListener('click', () => {
            showView(mainView);
        });

        async function adminFetchUsers() {
            try {
                const users = await apiCall('adminGetUserData', { password: ADMIN_PASSWORD_FRONT });
                adminUserTable.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    const lockoutDate = user.LockoutEndDate ? new Date(user.LockoutEndDate).toISOString().split('T')[0] : '';
                    tr.innerHTML = `
                        <td>${user.UserID}</td>
                        <td>${user.BlogLink}</td>
                        <td>${new Date(user.RegistrationDate).toLocaleDateString()}</td>
                        <td>${user.Status}</td>
                        <td>${user.PenaltyCount}</td>
                        <td>${lockoutDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary admin-edit-btn" data-user-id="${user.UserID}">관리</button>
                        </td>
                    `;
                    adminUserTable.appendChild(tr);
                });
            } catch (error) {
                showAlert(adminAlert, error.message);
            }
        }

        adminUserTable.addEventListener('click', async (e) => {
            if (e.target.classList.contains('admin-edit-btn')) {
                const userId = e.target.dataset.userId;
                const row = e.target.closest('tr');
                const cells = row.querySelectorAll('td');
                
                adminEditTitle.textContent = `${userId}님 정보 수정`;
                adminEditUserId.value = userId;
                adminEditStatus.value = cells[3].textContent;
                adminEditPenaltyCount.value = cells[4].textContent;
                adminEditLockoutDate.value = cells[5].textContent;
                
                adminEditModal.show();
            }
        });
        
        adminSaveChangesButton.addEventListener('click', async () => {
            const userData = {
                UserID: adminEditUserId.value,
                Status: adminEditStatus.value.trim(),
                PenaltyCount: parseInt(adminEditPenaltyCount.value, 10),
                LockoutEndDate: adminEditLockoutDate.value.trim()
            };

            adminSaveChangesButton.disabled = true;
            try {
                const data = await apiCall('adminUpdateUser', { password: ADMIN_PASSWORD_FRONT, userData });
                showAlert(adminAlert, data.message, 'success');
                adminEditModal.hide();
                adminFetchUsers(); // Refresh table
            } catch (error) {
                showAlert(adminAlert, error.message);
            } finally {
                adminSaveChangesButton.disabled = false;
            }
        });
        
        // --- Init App ---
        init();
    });
    </script>
</body>
</html>
