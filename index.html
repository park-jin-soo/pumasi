<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블로그 자동화 센터 V3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* [신규] 3단 레이아웃 스타일 */
        .main-layout {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .banner-container {
            width: 180px; /* 배너 컨테이너 너비 */
            flex-shrink: 0;
            padding-top: 8rem; /* 헤더 높이만큼 패딩 추가 */
        }
        .banner-container img {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .app-container {
             max-width: 800px;
             width: 100%;
        }
        /* 화면이 1200px보다 작아지면 배너 숨김 */
        @media (max-width: 1200px) {
            .banner-container {
                display: none;
            }
        }
        /* 기존 스타일 */
        .header { padding: 2rem 0; text-align: center; }
        .header h1 { font-weight: 700; }
        .auth-container { max-width: 400px; margin: auto; }
        .hidden { display: none; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
        .calendar-title { display: flex; align-items: baseline; gap: 0.75rem;}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-name { text-align: center; font-weight: bold; color: #6c757d; padding-bottom: 0.5rem;}
        .calendar-day { background-color: #fff; border: 1px solid #e9ecef; border-radius: 0.375rem; min-height: 80px; padding: 0.5rem; display: flex; flex-direction: column; font-size: 0.9rem; }
        .calendar-day .day-number { font-weight: bold; }
        .calendar-day.sunday .day-number { color: #dc3545; }
        .calendar-day.saturday .day-number { color: #0d6efd; }
        .calendar-day .link-count { font-size: 0.75rem; color: #198754; font-weight: bold; margin-top: auto; align-self: flex-end; }
        .calendar-day.other-month { background-color: #f8f9fa; color: #ced4da; }
        .calendar-day.today { border: 2px solid #198754; position: relative; }
        .calendar-day.active-day { cursor: pointer; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25); }
        .calendar-day.active-day:hover { background-color: #e9f5ee; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        #completionBtn:disabled { cursor: not-allowed; }
        .penalty-1 { color: #ffc107; }
        .penalty-2 { color: #fd7e14; }
        .penalty-3 { color: #dc3545; font-weight: bold; }
        .today-marker { font-weight: bold; color: #d63384; text-align: center; animation: pulse 1.5s infinite; margin-top: 4px; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .rules-box { background-color: #eef7ff; border-left: 5px solid #0d6efd; padding: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .penalty-info { list-style-type: none; padding-left: 0; }
        .penalty-info li { margin-bottom: 0.5rem; }
        .penalty-info .badge { margin-right: 8px; }
        .status-active { color: #198754; font-weight: bold; }
        .status-blocked { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="main-layout">
        <div id="left-banners" class="banner-container"></div>
        
        <div class="app-container">
            <header class="header"><h1>블로그 자동화 센터 V3.0</h1></header>

            <div class="alert alert-warning border-warning mb-3" style="background-color: #fff3cd; border-left: 5px solid #ffc107;">
                <div class="text-center">
                    <strong style="color: #856404;">오픈채팅방 가입회원만 회원가입이 가능합니다.</strong><br>
                    <span style="color: #dc3545; font-weight: bold;">블로그 대행사, 실행사 등 관련 마케터는 적발시 바로 내보내기 됩니다.</span>
                </div>
            </div>

            <div class="text-center mb-4">
                <a href="https://open.kakao.com/o/g0BjbBQh" target="_blank" rel="noopener noreferrer" class="btn btn-warning fw-bold">
                    카카오톡 오픈채팅방으로 들어가기
                </a>
            </div>

            <div id="authView">
                <div class="card auth-container">
                    <div class="card-body p-4">
                        <ul class="nav nav-tabs nav-fill mb-4" id="authTab" role="tablist">
                          <li class="nav-item" role="presentation"><button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">로그인</button></li>
                          <li class="nav-item" role="presentation"><button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">회원가입</button></li>
                        </ul>
                        <div class="tab-content">
                          <div class="tab-pane active" id="login" role="tabpanel"><h5 class="card-title text-center mb-3">로그인</h5><div class="mb-3"><label for="loginIdInput" class="form-label">블로그 아이디</label><input type="text" class="form-control" id="loginIdInput"></div><div class="d-grid"><button id="loginButton" class="btn btn-primary">로그인</button></div></div>
                          <div class="tab-pane" id="register" role="tabpanel"><h5 class="card-title text-center mb-3">회원가입</h5><div class="mb-3"><label for="registerIdInput" class="form-label">블로그 아이디</label><input type="text" class="form-control" id="registerIdInput" placeholder="블로그닉네임이 아닌 아이디를 입력해주세요"></div><div class="mb-3"><label for="registerLinkInput" class="form-label">블로그 링크 (모바일)</label><input type="url" class="form-control" id="registerLinkInput" placeholder="https://m.blog.naver.com/아이디" readonly></div><div class="mb-3"><label for="registerPostCountInput" class="form-label">1주일 블로그 포스팅 횟수(3회 이하 가입금지)</label><input type="number" class="form-control" id="registerPostCountInput" placeholder="최소 3회 이상" min="0"></div><div class="mb-4"><h6 class="fw-bold text-primary mb-3">안내문 - 꼭 읽어보세요</h6><div class="border p-3 mb-3" style="background-color: #f8f9fa; font-size: 0.9rem; line-height: 1.5;"><p class="mb-2">오픈채팅방 가입은 상단 클릭후 가입하세요</p><p class="mb-2">본 품앗이 프로그램 및 블로그 관련프로그램 사용하시려면 카카오톡 오픈채팅방의 회원에 한해서만 가입이 승인 이됩니다.</p><p class="mb-2">저희 채우미 자동품앗이 회원으로 활동하시려면 1주일 최소3회 이상 월 12회 이상의 포스팅을 유지하셔야 합니다.</p><p class="mb-2">품앗이를 기본으로 하는 방이므로 프로그램만 사용하시려 하신다면 죄송하지만 가입이 어렵습니다.</p><p class="mb-0">품앗이 보다 다른 프로그램 사용량이 많아질경우 유료로 전환 할 예정입니다.</p></div><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="isMemberCheck"><label class="form-check-label" for="isMemberCheck">회원이신 가요?</label></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="agreeTermsCheck"><label class="form-check-label" for="agreeTermsCheck">안내문 내용 확인하였습니다.</label></div></div><div class="d-grid"><button id="registerButton" class="btn btn-success">가입하기</button></div></div>
                        </div>
                        <div id="authAlert" class="alert mt-3 hidden" role="alert"></div>
                    </div>
                </div>
            </div>
            <main id="mainView" class="hidden">
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div><p class="mb-1"><strong><span id="welcomeMessage"></span></strong>님, 환영합니다.</p><small class="text-muted" id="userInfoText"></small></div>
                            <div><button id="adminLoginBtn" class="btn btn-sm btn-outline-danger me-2">관리자</button><button id="logoutButton" class="btn btn-sm btn-outline-secondary">로그아웃</button></div>
                        </div>
                    </div>
                </div>
                <ul class="nav nav-tabs nav-fill mb-3" id="mainAppTab" role="tablist">
                  <li class="nav-item" role="presentation"><button class="nav-link active" id="submission-tab" data-bs-toggle="tab" data-bs-target="#submission" type="button" role="tab">품앗이 링크 저장</button></li>
                  <li class="nav-item" role="presentation"><button class="nav-link" id="completion-tab" data-bs-toggle="tab" data-bs-target="#completion" type="button" role="tab">품앗이 완료 확인</button></li>
                  <li class="nav-item" role="presentation"><button class="nav-link" id="downloads-tab" data-bs-toggle="tab" data-bs-target="#downloads" type="button" role="tab">품앗이 미완료</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane active" id="submission" role="tabpanel">
                      <div class="rules-box">
                          <h6 class="mb-2 fw-bold">📢 링크 저장/삭제 규칙</h6>
                          <ul>
                              <li>품앗이에 참여할 링크는 <strong>당일 17시 59분까지</strong> 등록/수정/삭제할 수 있습니다.</li>
                              <li>급한 사정으로 품앗이가 어렵다면, 반드시 <strong>17시 59분까지 링크를 삭제</strong>해 주세요. <strong>18시 이후에는 삭제가 불가</strong>합니다.</li>
                              <li>품앗이 활동을 모두 마친 후, <strong>당일 23시 30분까지 '품앗이 완료 확인' 탭에서 완료 보고</strong>를 해야 패널티를 받지 않습니다.</li>
                          </ul>
                      </div>
                      <div class="card"><div class="card-body"><div class="calendar-header"><button id="prevMonth" class="btn btn-outline-secondary">&lt;</button><div class="calendar-title"><h4 id="currentMonthYear" class="mb-0"></h4><span id="monthlyTotalCount" class="badge bg-secondary"></span></div><button id="nextMonth" class="btn btn-outline-secondary">&gt;</button></div><div class="calendar-grid"><div class="calendar-day-name sunday">일</div><div class="calendar-day-name">월</div><div class="calendar-day-name">화</div><div class="calendar-day-name">수</div><div class="calendar-day-name">목</div><div class="calendar-day-name">금</div><div class="calendar-day-name saturday">토</div></div><div class="calendar-grid" id="calendarBody"></div></div></div>
                  </div>
                  <div class="tab-pane" id="completion" role="tabpanel">
                       <div class="rules-box">
                          <h6 class="mb-2 fw-bold">📢 완료 확인 규칙 및 패널티 안내</h6>
                          <p class="mb-2">품앗이 완료 보고는 <strong>당일 저녁 6시 30분 ~ 밤 11시 30분</strong> 사이에만 가능합니다.<br>시간 내 완료 보고를 하지 않을 경우 미완료로 처리되며, 아래와 같이 패널티가 부과됩니다.</p>
                          <ul class="penalty-info">
                              <li><span class="badge bg-warning text-dark">패널티 1회</span><strong>봉사</strong> (본인 링크 제출 불가, 다른 회원 품앗이만 진행)</li>
                              <li><span class="badge bg-danger">패널티 2회</span><strong>7일간 사용 금지</strong></li>
                              <li><span class="badge bg-dark">패널티 3회</span><strong>회원 자격 박탈</strong></li>
                          </ul>
                      </div>
                      <div class="card mb-4"><div class="card-header"><h4>금일 품앗이 완료 보고</h4></div><div class="card-body text-center"><p id="completionTimer" class="text-muted"></p><button id="completionBtn" class="btn btn-success btn-lg" disabled>품앗이 완료 확인</button></div></div>
                  </div>
                  <div class="tab-pane" id="downloads" role="tabpanel">
                       <div class="rules-box">
                          <h6 class="mb-2 fw-bold">📢 품앗이 미완료 회원 현황</h6>
                          <ul>
                              <li><strong>어제자 활동 완료 보고서:</strong> 매일 밤 12시 5분 이후 생성되며, 미완료 회원 및 패널티 현황을 확인할 수 있습니다.</li>
                              <li>미완료 회원은 자동으로 패널티가 부과되며, 패널티 횟수에 따라 제재가 적용됩니다.</li>
                          </ul>
                      </div>
                      <div class="card"><div class="card-header"><h4>어제자 미완료 회원 목록</h4></div><div id="reportContent" class="card-body"><p class="text-center">보고서를 불러오는 중입니다...</p></div></div>
                  </div>
                </div>
            </main>
            <div id="adminView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0">관리자 모드</h2>
                        <button id="adminDownloadTodayLinksBtn" class="btn btn-success ms-3">오늘 링크 목록 다운로드</button>
                    </div>
                    <button id="exitAdminBtn" class="btn btn-secondary">메인으로 돌아가기</button>
                </div>
                <div id="adminAlert" class="alert mt-3 hidden" role="alert"></div>
                
                <ul class="nav nav-tabs nav-fill mb-3" id="adminTab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="user-mgm-tab" data-bs-toggle="tab" data-bs-target="#user-mgm" type="button" role="tab">회원 관리</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="ad-mgm-tab" data-bs-toggle="tab" data-bs-target="#ad-mgm" type="button" role="tab">광고 관리</button></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="user-mgm" role="tabpanel">
                        <div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>아이디</th><th>블로그 링크</th><th>가입일</th><th>상태</th><th>패널티</th><th>잠금 종료일</th><th>관리</th></tr></thead><tbody id="adminUserTable"></tbody></table></div>
                    </div>
                    <div class="tab-pane" id="ad-mgm" role="tabpanel">
                         <div class="card">
                            <div class="card-header">광고 배너 관리</div>
                            <div class="card-body">
                                <p class="card-text small text-muted">
                                    좌측 배너는 1-5번, 우측 배너는 6-10번 슬롯에 해당합니다.<br>
                                    이미지 URL과 연결할 링크 주소를 입력하고 '저장' 버튼을 누르세요. 내용을 비우고 저장하면 배너가 사라집니다.
                                </p>
                                <div id="adminBannersContainer" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="right-banners" class="banner-container"></div>
    </div>
    <div class="modal fade" id="linkModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-info small">네이버 <b>모바일 버전(m.blog.naver.com)</b> 링크만 가능합니다.<br>(PC버전, <b>클립(Clip)</b>, 단축URL, 타 블로그 불가)</div><p><strong>아이디:</strong> <span id="modalUserId"></span></p><div class="mb-3"><label class="form-label">링크 1 (필수)</label><input type="url" class="form-control" id="linkInput1" placeholder="https://m.blog.naver.com/..."></div><div class="mb-3"><label class="form-label">링크 2</label><input type="url" class="form-control" id="linkInput2" placeholder="https://m.blog.naver.com/..."></div><div class="mb-3"><label class="form-label">링크 3</label><input type="url" class="form-control" id="linkInput3" placeholder="https://m.blog.naver.com/..."></div><div id="linkModalAlert" class="alert mt-3 hidden" role="alert"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button><button type="button" class="btn btn-danger hidden" id="deleteLinksButton">삭제하기</button><button type="button" class="btn btn-primary" id="saveLinksButton">저장하기</button></div></div></div></div>
    <div class="modal fade" id="completionModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">품앗이 완료 확인</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>금일 모든 품앗이 완료 되었음을 보고 합니다. 좋아요, 댓글, 체류 완료 되었습니다.</p><p class="text-muted small">아래 확인버튼 누르시면 금일 품앗이는 모두 완료됩니다.</p><div id="completionModalAlert" class="alert mt-3 hidden" role="alert"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="confirmCompletionButton">확인</button></div></div></div></div>
    <div class="modal fade" id="adminPasswordModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">관리자 로그인</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label for="adminPasswordInput" class="form-label">비밀번호</label><input type="password" class="form-control" id="adminPasswordInput" autocomplete="new-password"></div><div id="adminPasswordAlert" class="alert alert-danger hidden" role="alert"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="adminSubmitPasswordButton">진입</button></div></div></div></div>
    <div class="modal fade" id="adminEditModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="adminEditTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="adminEditUserId"><div class="mb-3"><label class="form-label">상태 (ACTIVE, BLOCKED)</label><input type="text" class="form-control" id="adminEditStatus"></div><div class="mb-3"><label class="form-label">패널티 횟수</label><input type="number" class="form-control" id="adminEditPenaltyCount" min="0"></div><div class="mb-3"><label class="form-label">잠금 종료일 (yyyy-mm-dd 또는 비우기)</label><input type="text" class="form-control" id="adminEditLockoutDate"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="adminSaveChangesButton">변경사항 저장</button></div></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNRzMS3VBITKAdwlecbqRawQ1NNQ3YSZO6EKAKbRNDs4ouh8PA-O9LsraWlaKD2JId/exec';
    const ADMIN_PASSWORD_FRONT = "7702";
    document.addEventListener('DOMContentLoaded', () => {
        const authView = document.getElementById('authView');
        const mainView = document.getElementById('mainView');
        const adminView = document.getElementById('adminView');
        const allViews = [authView, mainView, adminView];
        const loginIdInput = document.getElementById('loginIdInput');
        const loginButton = document.getElementById('loginButton');
        const registerIdInput = document.getElementById('registerIdInput');
        const registerLinkInput = document.getElementById('registerLinkInput');
        const registerPostCountInput = document.getElementById('registerPostCountInput');
        const isMemberCheck = document.getElementById('isMemberCheck');
        const agreeTermsCheck = document.getElementById('agreeTermsCheck');
        const registerButton = document.getElementById('registerButton');
        const authAlert = document.getElementById('authAlert');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const userInfoText = document.getElementById('userInfoText');
        const logoutButton = document.getElementById('logoutButton');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const monthlyTotalCount = document.getElementById('monthlyTotalCount');
        const calendarBody = document.getElementById('calendarBody');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const completionBtn = document.getElementById('completionBtn');
        const completionTimer = document.getElementById('completionTimer');
        const reportContent = document.getElementById('reportContent');
        const linkModal = new bootstrap.Modal(document.getElementById('linkModal'));
        const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
        const adminPasswordModal = new bootstrap.Modal(document.getElementById('adminPasswordModal'));
        const adminEditModal = new bootstrap.Modal(document.getElementById('adminEditModal'));
        const modalTitle = document.getElementById('modalTitle');
        const modalUserId = document.getElementById('modalUserId');
        const linkInputs = [document.getElementById('linkInput1'), document.getElementById('linkInput2'), document.getElementById('linkInput3')];
        const linkModalAlert = document.getElementById('linkModalAlert');
        const saveLinksButton = document.getElementById('saveLinksButton');
        const deleteLinksButton = document.getElementById('deleteLinksButton');
        const confirmCompletionButton = document.getElementById('confirmCompletionButton');
        const completionModalAlert = document.getElementById('completionModalAlert');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminSubmitPasswordButton = document.getElementById('adminSubmitPasswordButton');
        const adminPasswordAlert = document.getElementById('adminPasswordAlert');
        const adminUserTable = document.getElementById('adminUserTable');
        const exitAdminBtn = document.getElementById('exitAdminBtn');
        const adminAlert = document.getElementById('adminAlert');
        const adminDownloadTodayLinksBtn = document.getElementById('adminDownloadTodayLinksBtn');
        const adminBannersContainer = document.getElementById('adminBannersContainer');
        const leftBanners = document.getElementById('left-banners');
        const rightBanners = document.getElementById('right-banners');
        const adminEditTitle = document.getElementById('adminEditTitle');
        const adminEditUserId = document.getElementById('adminEditUserId');
        const adminEditStatus = document.getElementById('adminEditStatus');
        const adminEditPenaltyCount = document.getElementById('adminEditPenaltyCount');
        const adminEditLockoutDate = document.getElementById('adminEditLockoutDate');
        const adminSaveChangesButton = document.getElementById('adminSaveChangesButton');
        let currentCalendarDate = new Date();
        let loggedInUserId = null;
        let selectedDateStr = '';
        let completionInterval;

        function showView(viewToShow) { allViews.forEach(view => view.classList.add('hidden')); viewToShow.classList.remove('hidden'); }
        function showAlert(alertElement, message, type = 'danger') { alertElement.textContent = message; alertElement.className = `alert alert-${type}`; }
        function hideAlert(alertElement) { alertElement.classList.add('hidden'); }
        async function apiCall(action, params = {}) {
            const isGet = action.startsWith('get');
            const fullUrl = isGet ? `${SCRIPT_URL}?action=${action}&` + new URLSearchParams(params) : SCRIPT_URL;
            const options = { method: isGet ? 'GET' : 'POST', redirect: 'follow' };
            if (!isGet) {
                options.body = JSON.stringify({ action, ...params });
                options.headers = { "Content-Type": "text/plain;charset=utf-8" };
            }
            try {
                const response = await fetch(fullUrl, options);
                if (!response.ok) throw new Error("네트워크 응답이 올바르지 않습니다.");
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error('API Call Error:', error);
                throw error;
            }
        }
        function init() {
            loggedInUserId = localStorage.getItem('pumasi_user_id');
            if (loggedInUserId) {
                showView(mainView);
                initializeApp();
            } else {
                showView(authView);
            }
            
            // 블로그 아이디 입력 시 자동 링크 생성
            registerIdInput.addEventListener('input', function() {
                const userId = this.value.trim();
                if (userId) {
                    registerLinkInput.value = `https://m.blog.naver.com/${userId}`;
                } else {
                    registerLinkInput.value = '';
                }
            });
        }
        function initializeApp() {
            welcomeMessage.textContent = loggedInUserId;
            const regDate = localStorage.getItem('pumasi_reg_date');
            if (regDate) { displayUserInfo(regDate); }
            renderCalendar(currentCalendarDate);
            startCompletionTimer();
            loadReportData();
            loadBanners(); // [신규] 배너 로딩
        }
        async function loadBanners() {
            try {
                const banners = await apiCall('getPublicBanners');
                leftBanners.innerHTML = '';
                rightBanners.innerHTML = '';
                banners.forEach(banner => {
                    const bannerEl = document.createElement('a');
                    bannerEl.href = banner.destinationUrl;
                    bannerEl.target = '_blank';
                    bannerEl.rel = 'noopener noreferrer';
                    bannerEl.innerHTML = `<img src="${banner.imageUrl}" alt="Banner ${banner.slotId}">`;

                    if(banner.slotId <= 5) {
                        leftBanners.appendChild(bannerEl);
                    } else {
                        rightBanners.appendChild(bannerEl);
                    }
                });
            } catch (error) {
                console.error('Failed to load banners:', error);
            }
        }
        function displayUserInfo(regDateStr) {
            if (!regDateStr) return;
            const regDate = new Date(regDateStr);
            const today = new Date();
            const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
            const regDateUTC = new Date(Date.UTC(regDate.getFullYear(), regDate.getMonth(), regDate.getDate()));
            const diffTime = todayUTC - regDateUTC;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            userInfoText.textContent = `가입일: ${regDateStr} (가입 ${diffDays}일차)`;
        }
        loginButton.addEventListener('click', async () => {
            const userId = loginIdInput.value.trim();
            if (!userId) { showAlert(authAlert, "아이디를 입력하세요."); return; }
            try {
                const data = await apiCall('loginUser', { userId });
                localStorage.setItem('pumasi_user_id', data.userId);
                localStorage.setItem('pumasi_reg_date', data.registrationDate);
                loggedInUserId = data.userId;
                showView(mainView);
                initializeApp();
            } catch (error) {
                showAlert(authAlert, error.message);
            }
        });
        registerButton.addEventListener('click', async () => {
            const userId = registerIdInput.value.trim();
            const blogLink = registerLinkInput.value.trim();
            const postCount = parseInt(registerPostCountInput.value) || 0;
            
            // 입력 검증
            if (!userId || !blogLink) { 
                showAlert(authAlert, "아이디와 블로그 링크를 모두 입력하세요."); 
                return; 
            }
            
            if (postCount < 3) {
                showAlert(authAlert, "1주일 포스팅 횟수는 최소 3회 이상이어야 합니다.");
                return;
            }
            
            // 체크박스 검증
            if (!isMemberCheck.checked) {
                showAlert(authAlert, "카카오톡 오픈채팅방 회원 여부를 확인해주세요.");
                return;
            }
            
            if (!agreeTermsCheck.checked) {
                showAlert(authAlert, "안내문 내용을 확인하고 동의해주세요.");
                return;
            }
            
            try {
                const data = await apiCall('registerUser', { userId, blogLink, postCount });
                showAlert(authAlert, data.message, 'success');
                document.getElementById('login-tab').click();
            } catch (error) {
                showAlert(authAlert, error.message);
            }
        });
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('pumasi_user_id');
            localStorage.removeItem('pumasi_reg_date');
            loggedInUserId = null;
            clearInterval(completionInterval);
            showView(authView);
            location.reload();
        });
        async function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            currentMonthYear.textContent = `${year}년 ${month + 1}월`;
            calendarBody.innerHTML = `<div class="d-flex justify-content-center p-5"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            monthlyTotalCount.textContent = '...';
            let linkCounts = {};
            try {
                linkCounts = await apiCall('getLinkCountsForMonth', { year: year, month: month + 1 });
            } catch (error) {
                console.error("Failed to fetch link counts:", error);
                monthlyTotalCount.textContent = '오류';
            }
            calendarBody.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarBody.innerHTML += `<div class="calendar-day other-month"></div>`; }
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            let totalLinksThisMonth = 0;
            for (let i = 1; i <= lastDate; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                const dayOfWeek = new Date(year, month, i).getDay();
                if (dayOfWeek === 0) dayDiv.classList.add('sunday');
                else if (dayOfWeek === 6) dayDiv.classList.add('saturday');
                const dayLinkCount = linkCounts[i] || 0;
                totalLinksThisMonth += dayLinkCount;
                let countHtml = dayLinkCount > 0 ? `<div class="link-count">총 ${dayLinkCount}개</div>` : '';
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (currentDateStr === todayStr) {
                    dayDiv.classList.add('today', 'active-day');
                    dayDiv.dataset.date = currentDateStr;
                    dayDiv.innerHTML = `<div class="day-number">${i}</div><div class="today-marker">👇 클릭!</div>${countHtml}`;
                } else {
                    dayDiv.innerHTML = `<div class="day-number">${i}</div>${countHtml}`;
                }
                calendarBody.appendChild(dayDiv);
            }
            monthlyTotalCount.textContent = `월 합산: ${totalLinksThisMonth}개`;
        }
        prevMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate); });
        nextMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate); });
        
        calendarBody.addEventListener('click', async (e) => {
            const dayElement = e.target.closest('.active-day');
            if (dayElement) {
                selectedDateStr = dayElement.dataset.date;
                modalTitle.textContent = `${selectedDateStr} 링크 등록/수정`;
                modalUserId.textContent = loggedInUserId;
                linkInputs.forEach(input => input.value = '');
                hideAlert(linkModalAlert);
                saveLinksButton.textContent = '저장하기';
                
                deleteLinksButton.classList.add('hidden');
                linkModal.show();
                
                try {
                    const existingLinks = await apiCall('getLinksForDate', { userId: loggedInUserId, date: selectedDateStr });
                    if (existingLinks && Array.isArray(existingLinks) && existingLinks.some(link => link)) {
                        saveLinksButton.textContent = '수정하기';
                        linkInputs[0].value = existingLinks[0] || '';
                        linkInputs[1].value = existingLinks[1] || '';
                        linkInputs[2].value = existingLinks[2] || '';
                        deleteLinksButton.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching links for date:", error);
                    showAlert(linkModalAlert, '링크를 불러오는 데 실패했습니다: ' + error.message);
                }
                
                const nowKST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
                const kstHours = nowKST.getHours();

                if (kstHours >= 18) {
                    saveLinksButton.disabled = true;
                    saveLinksButton.title = "오후 6시 이후에는 저장/수정이 불가합니다.";
                    deleteLinksButton.disabled = true;
                    deleteLinksButton.title = "오후 6시 이후에는 삭제가 불가합니다.";
                } else {
                    saveLinksButton.disabled = false;
                    saveLinksButton.title = "";
                    deleteLinksButton.disabled = false;
                    deleteLinksButton.title = "";
                }
            }
        });
        
        function validateLink(url) {
           if (!url.startsWith("https://m.blog.naver.com")) return false;
           if (url.toLowerCase().includes("clip")) return false;
           return true;
        }

        saveLinksButton.addEventListener('click', async () => {
            const links = linkInputs.map(input => input.value.trim()).filter(link => link);
            if (links.length === 0) { showAlert(linkModalAlert, '링크를 하나 이상 입력해주세요.'); return; }
            for (const link of links) {
                if (!validateLink(link)) {
                    showAlert(linkModalAlert, '네이버 모바일 버전 링크를 입력해주세요. (Clip 포함 불가)');
                    return;
                }
            }
            saveLinksButton.disabled = true;
            try {
                const data = await apiCall('saveLinks', { userId: loggedInUserId, date: selectedDateStr, links });
                showAlert(linkModalAlert, data.message, 'success');
                setTimeout(() => { linkModal.hide(); renderCalendar(currentCalendarDate); }, 1500);
            } catch (error) {
                showAlert(linkModalAlert, error.message);
            } finally {
                const nowKST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
                if (nowKST.getHours() < 18) {
                    saveLinksButton.disabled = false;
                }
            }
        });

        deleteLinksButton.addEventListener('click', async () => {
            if (confirm(`정말로 ${selectedDateStr}에 등록된 모든 링크를 삭제하시겠습니까?`)) {
                deleteLinksButton.disabled = true;
                try {
                    const data = await apiCall('deleteLinks', { userId: loggedInUserId, date: selectedDateStr });
                    showAlert(linkModalAlert, data.message, 'success');
                    setTimeout(() => { linkModal.hide(); renderCalendar(currentCalendarDate); }, 1500);
                } catch (error) {
                    showAlert(linkModalAlert, error.message);
                } finally {
                    const nowKST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
                    if (nowKST.getHours() < 18) {
                        deleteLinksButton.disabled = false;
                    }
                }
            }
        });

        function startCompletionTimer() {
            clearInterval(completionInterval);
            completionInterval = setInterval(updateCompletionButtonStatus, 1000);
            updateCompletionButtonStatus();
        }
        function updateCompletionButtonStatus() {
            const kstNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
            const kstHours = kstNow.getHours();
            const kstMinutes = kstNow.getMinutes();
            const startTime = 18.5, endTime = 23.5;
            const currentTime = kstHours + kstMinutes / 60;

            if (currentTime >= startTime && currentTime < endTime) {
                completionBtn.disabled = false;
                completionTimer.textContent = "지금 완료 보고가 가능합니다.";
            } else {
                completionBtn.disabled = true;
                let nextStart = new Date(kstNow);
                nextStart.setHours(18, 30, 0, 0);
                if (kstNow.getTime() > nextStart.getTime()) {
                    nextStart.setDate(nextStart.getDate() + 1);
                }
                const diff = nextStart - kstNow;
                const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
                const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                completionTimer.textContent = `완료 보고 활성화까지 남은 시간: ${h}:${m}:${s}`;
            }
        }
        completionBtn.addEventListener('click', () => {
            hideAlert(completionModalAlert);
            completionModal.show();
        });
        confirmCompletionButton.addEventListener('click', async () => {
            const todayKST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
            const todayStr = `${todayKST.getFullYear()}-${String(todayKST.getMonth() + 1).padStart(2, '0')}-${String(todayKST.getDate()).padStart(2, '0')}`;
            confirmCompletionButton.disabled = true;
            try {
                const data = await apiCall('recordCompletion', { userId: loggedInUserId, date: todayStr });
                showAlert(completionModalAlert, data.message, 'success');
                setTimeout(() => completionModal.hide(), 1500);
            } catch (error) {
                showAlert(completionModalAlert, error.message);
            } finally {
                confirmCompletionButton.disabled = false;
            }
        });
        async function loadReportData() {
            try {
                const data = await apiCall('getReportData');
                let html = `<p class="mb-2"><strong>보고서 날짜: ${data.date}</strong></p><p class="mb-3"><strong>완료 인원: ${data.completedCount}명</strong></p><h5>미완료 회원 목록</h5>`;
                if (data.incompleteUsers.length === 0) {
                    html += `<p class="text-muted">미완료 회원이 없습니다.</p>`;
                } else {
                    html += `<ul class="list-group">`;
                    data.incompleteUsers.forEach(user => {
                        const newPenaltyCount = (parseInt(user.penaltyCount) || 0) + 1;
                        const penaltyClass = `penalty-${Math.min(newPenaltyCount, 3)}`;
                        html += `<li class="list-group-item">${user.userId} <span class="badge bg-warning text-dark ${penaltyClass}">패널티 ${newPenaltyCount}회</span></li>`;
                    });
                    html += `</ul>`;
                }
                reportContent.innerHTML = html;
            } catch (error) {
                reportContent.innerHTML = `<p class="text-danger">보고서 로딩 실패: ${error.message}</p>`;
            }
        }
        adminLoginBtn.addEventListener('click', () => {
            adminPasswordInput.value = '';
            hideAlert(adminPasswordAlert);
            adminPasswordModal.show();
        });
        adminSubmitPasswordButton.addEventListener('click', () => {
            const pass = adminPasswordInput.value;
            if (pass === ADMIN_PASSWORD_FRONT) {
                adminPasswordModal.hide();
                showView(adminView);
                adminFetchUsers();
                adminLoadBanners(); // [신규] 관리자 배너 관리 UI 로딩
            } else {
                showAlert(adminPasswordAlert, "비밀번호가 틀렸습니다.");
            }
        });
        exitAdminBtn.addEventListener('click', () => {
            showView(mainView);
        });

        adminDownloadTodayLinksBtn.addEventListener('click', async () => {
            const btn = adminDownloadTodayLinksBtn;
            btn.disabled = true;
            btn.textContent = '파일 생성 중...';
            hideAlert(adminAlert);
            try {
                const data = await apiCall('adminGenerateTodaysLinkReport', { password: ADMIN_PASSWORD_FRONT });
                if(data.downloadUrl) {
                    showAlert(adminAlert, '파일 생성이 완료되었습니다. 잠시 후 다운로드가 시작됩니다.', 'success');
                    window.open(data.downloadUrl, '_blank');
                }
            } catch (error) {
                showAlert(adminAlert, error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '오늘 링크 목록 다운로드';
            }
        });

        async function adminFetchUsers() {
            try {
                const users = await apiCall('adminGetUserData', { password: ADMIN_PASSWORD_FRONT });
                adminUserTable.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    const lockoutDate = user.LockoutEndDate ? new Date(user.LockoutEndDate).toISOString().split('T')[0] : '';
                    const regDate = user.RegistrationDate ? new Date(user.RegistrationDate).toISOString().split('T')[0] : '';
                    
                    let statusKorean = '';
                    let statusClass = '';
                    if (user.Status === 'ACTIVE') {
                        statusKorean = '활성';
                        statusClass = 'status-active';
                    } else if (user.Status === 'BLOCKED') {
                        statusKorean = '차단';
                        statusClass = 'status-blocked';
                    } else {
                        statusKorean = user.Status;
                    }

                    tr.innerHTML = `<td>${user.UserID}</td>
                                    <td><a href="${user.BlogLink}" target="_blank">${user.BlogLink}</a></td>
                                    <td>${regDate}</td>
                                    <td data-status="${user.Status}" class="${statusClass}">${statusKorean}</td>
                                    <td>${user.PenaltyCount}</td>
                                    <td>${lockoutDate}</td>
                                    <td><button class="btn btn-sm btn-primary admin-edit-btn" data-user-id="${user.UserID}">관리</button></td>`;
                    adminUserTable.appendChild(tr);
                });
            } catch (error) {
                showAlert(adminAlert, error.message);
            }
        }
        
        // [신규] 관리자용 배너 관리 UI를 생성하고 데이터를 채우는 함수
        async function adminLoadBanners() {
            hideAlert(adminAlert);
            adminBannersContainer.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
            try {
                const banners = await apiCall('adminGetBanners', { password: ADMIN_PASSWORD_FRONT });
                let html = '';
                for (let i = 1; i <= 10; i++) {
                    const banner = banners.find(b => b.SlotID == i) || {};
                    const title = i <= 5 ? `좌측 ${i}번` : `우측 ${i-5}번`;
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">${title} (슬롯 ${i})</h6>
                                <div class="mb-2">
                                    <label class="form-label small">이미지 URL</label>
                                    <input type="url" class="form-control" id="img-url-${i}" value="${banner.ImageURL || ''}">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">연결 링크 URL</label>
                                    <input type="url" class="form-control" id="dest-url-${i}" value="${banner.DestinationURL || ''}">
                                </div>
                                <button class="btn btn-primary btn-sm admin-save-banner-btn" data-slot-id="${i}">슬롯 ${i} 저장</button>
                            </div>
                        </div>
                    `;
                }
                adminBannersContainer.innerHTML = html;
            } catch (error) {
                showAlert(adminAlert, '배너 정보를 불러오는데 실패했습니다: ' + error.message);
            }
        }

        // [신규] 관리자 배너 저장 버튼 이벤트 처리
        adminBannersContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('admin-save-banner-btn')) {
                const btn = e.target;
                const slotId = btn.dataset.slotId;
                const imageUrl = document.getElementById(`img-url-${slotId}`).value.trim();
                const destinationUrl = document.getElementById(`dest-url-${slotId}`).value.trim();
                
                btn.disabled = true;
                btn.textContent = '저장 중...';
                hideAlert(adminAlert);

                try {
                    const result = await apiCall('adminUpdateBanner', {
                        password: ADMIN_PASSWORD_FRONT,
                        bannerData: { slotId, imageUrl, destinationUrl }
                    });
                    showAlert(adminAlert, result.message, 'success');
                } catch(error) {
                    showAlert(adminAlert, error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.textContent = `슬롯 ${slotId} 저장`;
                }
            }
        });

        adminUserTable.addEventListener('click', async (e) => {
            if (e.target.classList.contains('admin-edit-btn')) {
                const userId = e.target.dataset.userId;
                const row = e.target.closest('tr');
                const cells = row.querySelectorAll('td');
                adminEditTitle.textContent = `${userId}님 정보 수정`;
                adminEditUserId.value = userId;
                adminEditStatus.value = cells[3].dataset.status;
                adminEditPenaltyCount.value = cells[4].textContent;
                adminEditLockoutDate.value = cells[5].textContent;
                adminEditModal.show();
            }
        });
        adminSaveChangesButton.addEventListener('click', async () => {
            const userData = {
                UserID: adminEditUserId.value,
                Status: adminEditStatus.value.trim().toUpperCase(),
                PenaltyCount: parseInt(adminEditPenaltyCount.value, 10),
                LockoutEndDate: adminEditLockoutDate.value.trim()
            };
            adminSaveChangesButton.disabled = true;
            try {
                const data = await apiCall('adminUpdateUser', { password: ADMIN_PASSWORD_FRONT, userData });
                showAlert(adminAlert, data.message, 'success');
                adminEditModal.hide();
                adminFetchUsers();
            } catch (error) {
                showAlert(adminAlert, error.message);
            } finally {
                adminSaveChangesButton.disabled = false;
            }
        });

        init();
    });
    </script>
</body>
</html>
